<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>sc-filter</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', 'Courier New', monospace;
            background: #0a0a0a;
            color: #00ff00;
            padding: 20px;
            font-size: 14px;
            line-height: 1.6;
        }

        .terminal {
            max-width: 900px;
            margin: 0 auto;
            background: #000;
            border: 1px solid #333;
            box-shadow: 0 0 50px rgba(0, 255, 0, 0.1);
        }

        .terminal-header {
            background: #1a1a1a;
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .terminal-button {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #333;
        }

        .terminal-button.close { background: #ff5f56; }
        .terminal-button.minimize { background: #ffbd2e; }
        .terminal-button.maximize { background: #27c93f; }

        .terminal-title {
            margin-left: 10px;
            color: #666;
            font-size: 12px;
        }

        .terminal-body {
            padding: 20px;
            min-height: 400px;
        }

        .prompt-line {
            margin-bottom: 15px;
        }

        .prompt-symbol {
            color: #00ff00;
        }

        .prompt-path {
            color: #0088ff;
        }

        .command {
            color: #ff00ff;
        }

        input {
            background: transparent;
            border: none;
            color: #00ff00;
            font-family: inherit;
            font-size: inherit;
            outline: none;
            width: 100%;
            padding: 4px 0;
            border-bottom: 1px solid #222;
            margin: 8px 0;
        }

        input::placeholder {
            color: #444;
        }

        button {
            background: transparent;
            border: 1px solid #00ff00;
            color: #00ff00;
            padding: 8px 20px;
            font-family: inherit;
            font-size: inherit;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        button:hover:not(:disabled) {
            background: #00ff00;
            color: #000;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.5);
        }

        button:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .output {
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px solid #222;
        }

        .output-line {
            margin: 4px 0;
        }

        .error {
            color: #ff5555;
        }

        .success {
            color: #00ff00;
        }

        .info {
            color: #888;
        }

        .warning {
            color: #ffaa00;
        }

        .result-item {
            margin: 15px 0;
            display: flex;
            gap: 15px;
            padding: 8px 0;
            border-bottom: 1px dashed #222;
        }

        .result-item:hover {
            background: rgba(0, 255, 0, 0.02);
        }

        .result-avatar-link {
            flex-shrink: 0;
        }

        .result-avatar {
            width: 48px;
            height: 48px;
            border-radius: 4px;
            border: 1px solid #00ff00;
            object-fit: cover;
            display: block;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .result-avatar:hover {
            border-color: #00ffff;
            box-shadow: 0 0 8px rgba(0, 255, 0, 0.3);
        }

        .result-content {
            flex: 1;
            min-width: 0;
        }

        .result-header {
            display: flex;
            align-items: baseline;
            gap: 8px;
            margin-bottom: 4px;
        }

        .result-index {
            color: #666;
            font-size: 12px;
        }

        .result-name {
            color: #00ffff;
            font-weight: bold;
        }

        .result-username {
            color: #666;
            font-size: 12px;
        }

        .result-stats {
            display: flex;
            gap: 15px;
            margin: 4px 0;
            font-size: 12px;
        }

        .result-stat {
            color: #888;
        }

        .result-stat-value {
            color: #00ff00;
        }

        .result-link {
            color: #0088ff;
            text-decoration: none;
            font-size: 11px;
            opacity: 0.6;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .result-link:hover {
            opacity: 1;
            text-decoration: underline;
        }

        .loading {
            display: none;
        }

        .loading.active {
            display: block;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 16px;
            background: #00ff00;
            animation: blink 1s infinite;
            margin-left: 2px;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .quick-cmd {
            color: #666;
            cursor: pointer;
            text-decoration: underline;
            margin-right: 10px;
        }

        .quick-cmd:hover {
            color: #00ff00;
        }

        @media (max-width: 600px) {
            body {
                padding: 10px;
                font-size: 12px;
            }

            .terminal-body {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="terminal">
        <div class="terminal-header">
            <div class="terminal-button close"></div>
            <div class="terminal-button minimize"></div>
            <div class="terminal-button maximize"></div>
            <span class="terminal-title">sc-filter ‚Äî bash ‚Äî 80x24</span>
        </div>

        <div class="terminal-body">
            <div class="prompt-line">
                <span class="prompt-symbol">$</span>
                <span class="command"> sc-filter --help</span>
            </div>

            <div class="output-line info">usage: sc-filter [username] [location]</div>
            <div class="output-line info">find soundcloud users by location from a user's followings</div>
            <br>

            <div class="prompt-line">
                <span class="prompt-symbol">$</span>
                <span class="command"> sc-filter</span>
            </div>

            <div class="output-line">
                <label for="username" style="color: #888;">username:</label>
                <input
                    type="text"
                    id="username"
                    placeholder="gloomweaver777"
                    value="gloomweaver777"
                    autocomplete="off"
                >
            </div>

            <div class="output-line">
                <label for="location" style="color: #888;">location:</label>
                <input
                    type="text"
                    id="location"
                    placeholder="Berlin, Leipzig, Tbilisi..."
                    value="Tbilisi"
                    autocomplete="off"
                >
            </div>

            <div class="output-line" style="margin-top: 10px;">
                <span class="info">quick:</span>
                <span class="quick-cmd" onclick="quickSearch('Berlin')">Berlin</span>
                <span class="quick-cmd" onclick="quickSearch('Leipzig')">Leipzig</span>
                <span class="quick-cmd" onclick="quickSearch('Amsterdam')">Amsterdam</span>
                <span class="quick-cmd" onclick="quickSearch('Tbilisi')">Tbilisi</span>
            </div>

            <button onclick="search()" id="searchBtn">[ENTER]</button>

            <div class="loading" id="loading">
                <div class="output-line warning">‚è≥ fetching from soundcloud api...</div>
                <div class="output-line info">this may take a few seconds<span class="cursor"></span></div>
            </div>

            <div class="output" id="results" style="display: none;">
                <div id="resultsList"></div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'https://api-v2.soundcloud.com';
        // Try multiple CORS proxies (your Cloudflare Worker first, then fallbacks)
        const CORS_PROXIES = [
            'https://scmutuals.n-sander.workers.dev/?url=',
            'https://thingproxy.freeboard.io/fetch/',
            'https://api.allorigins.win/raw?url='
        ];
        let proxyIndex = 0;

        // Fallback client IDs (rotate if one stops working)
        const FALLBACK_CLIENT_IDS = [
            '8VAIbDYccOVbB1QV2LSOSqGILp5pxFkE',
            'iZIs9mchVcX5lhVRyQGGAYlNPVldzAoJ',
            'cqjGlvfCo63EIJe22pjNDPkHSJhNlMy5'
        ];
        let clientId = null;
        let fallbackIndex = 0;

        function getCorsProxy() {
            return CORS_PROXIES[proxyIndex % CORS_PROXIES.length];
        }

        function quickSearch(location) {
            document.getElementById('location').value = location;
            search();
        }

        function showError(message) {
            const resultsEl = document.getElementById('results');
            const proxyHelp = message.includes('API') || message.includes('network') ? `
                <br>
                <div class="output-line warning">note: free CORS proxies may be unreliable</div>
                <div class="output-line info">consider deploying your own proxy (see worker.js)</div>
            ` : '';
            resultsEl.innerHTML = `
                <div class="output-line error">‚úó error: ${message}</div>
                <div class="output-line info">try again or check your input</div>
                ${proxyHelp}
            `;
            resultsEl.style.display = 'block';
        }

        function showLoading() {
            document.getElementById('loading').classList.add('active');
            document.getElementById('searchBtn').disabled = true;
            document.getElementById('results').style.display = 'none';
        }

        function hideLoading() {
            document.getElementById('loading').classList.remove('active');
            document.getElementById('searchBtn').disabled = false;
        }

        async function getClientId() {
            if (clientId) return clientId;

            // Try fallback client IDs first (faster and more reliable)
            for (let i = fallbackIndex; i < FALLBACK_CLIENT_IDS.length; i++) {
                try {
                    const testId = FALLBACK_CLIENT_IDS[i];
                    // Test if this client ID works
                    const testUrl = `${API_BASE}/resolve?url=https://soundcloud.com/soundcloud&client_id=${testId}`;
                    const testResponse = await fetch(getCorsProxy() + encodeURIComponent(testUrl));

                    if (testResponse.ok) {
                        const text = await testResponse.text();
                        // Check if response is valid JSON
                        try {
                            JSON.parse(text);
                            clientId = testId;
                            fallbackIndex = i;
                            console.log('Using fallback client_id:', testId.substring(0, 10) + '...');
                            return clientId;
                        } catch (jsonError) {
                            console.log('Response not valid JSON, trying next proxy/ID...');
                            proxyIndex++;
                            continue;
                        }
                    }
                } catch (e) {
                    console.log('Fallback ID failed, trying next...', e.message);
                    proxyIndex++;
                    continue;
                }
            }

            // If fallbacks fail, try extracting from website
            try {
                const response = await fetch(getCorsProxy() + encodeURIComponent('https://soundcloud.com'));
                const html = await response.text();

                const scriptUrls = html.match(/<script[^>]+src="([^"]+)"/g) || [];

                for (const scriptTag of scriptUrls) {
                    const match = scriptTag.match(/src="([^"]+)"/);
                    if (!match || !match[1].includes('sndcdn.com')) continue;

                    try {
                        const scriptResponse = await fetch(getCorsProxy() + encodeURIComponent(match[1]));
                        const scriptText = await scriptResponse.text();
                        const clientIdMatch = scriptText.match(/client_id[=:]"([a-zA-Z0-9]+)"/);

                        if (clientIdMatch) {
                            clientId = clientIdMatch[1];
                            console.log('Extracted client_id from website');
                            return clientId;
                        }
                    } catch (e) {
                        continue;
                    }
                }

                throw new Error('Could not extract client_id');
            } catch (error) {
                throw new Error('Failed to get SoundCloud API access. Try again later.');
            }
        }

        async function resolveUser(username) {
            const cid = await getClientId();
            const url = `${API_BASE}/resolve?url=https://soundcloud.com/${username}&client_id=${cid}`;

            // Try with different proxies
            for (let attempt = 0; attempt < CORS_PROXIES.length; attempt++) {
                try {
                    const response = await fetch(getCorsProxy() + encodeURIComponent(url));

                    if (!response.ok) {
                        throw new Error('User not found');
                    }

                    const text = await response.text();
                    try {
                        const data = JSON.parse(text);
                        return data;
                    } catch (jsonError) {
                        throw new Error('Invalid response from API');
                    }
                } catch (e) {
                    console.log(`Proxy ${proxyIndex} failed, trying next...`, e.message);
                    proxyIndex++;
                    if (attempt === CORS_PROXIES.length - 1) {
                        throw new Error('User not found or network error');
                    }
                }
            }
        }

        async function getFollowings(userId) {
            const cid = await getClientId();
            let allFollowings = [];
            let nextHref = `${API_BASE}/users/${userId}/followings?client_id=${cid}&limit=200`;

            while (nextHref) {
                let success = false;
                let lastError = null;

                // Try with different proxies for this request
                for (let attempt = 0; attempt < CORS_PROXIES.length; attempt++) {
                    try {
                        const response = await fetch(getCorsProxy() + encodeURIComponent(nextHref));

                        if (!response.ok) {
                            throw new Error('Failed to fetch followings');
                        }

                        const text = await response.text();
                        let data;
                        try {
                            data = JSON.parse(text);
                        } catch (jsonError) {
                            throw new Error('Invalid JSON response from API');
                        }

                        allFollowings = allFollowings.concat(data.collection || []);
                        nextHref = data.next_href;

                        if (nextHref && !nextHref.includes('client_id')) {
                            nextHref += `&client_id=${cid}`;
                        }

                        success = true;
                        break;
                    } catch (e) {
                        console.log(`Proxy ${proxyIndex} failed for followings, trying next...`, e.message);
                        lastError = e;
                        proxyIndex++;
                    }
                }

                if (!success) {
                    throw new Error('Failed to fetch followings: ' + (lastError?.message || 'Network error'));
                }
            }

            return allFollowings;
        }

        function filterByLocation(users, location) {
            const locationLower = location.toLowerCase().trim();
            return users.filter(user => {
                const userLocation = user.city || '';
                const countryCode = user.country_code || '';
                const fullLocation = `${userLocation}, ${countryCode}`.toLowerCase();
                return fullLocation.includes(locationLower);
            });
        }

        function displayResults(users, location, username) {
            const resultsEl = document.getElementById('results');

            if (users.length === 0) {
                resultsEl.innerHTML = `
                    <div class="output-line error">‚úó no users found in "${location}"</div>
                    <div class="output-line info">0 matches from ${username}'s followings</div>
                `;
            } else {
                let html = `
                    <div class="output-line success">‚úì found ${users.length} user${users.length === 1 ? '' : 's'} in "${location}"</div>
                    <div class="output-line info">matches from ${username}'s followings</div>
                    <br>
                `;

                users.forEach((user, index) => {
                    // Prioritize full_name (display name) over username
                    const displayName = user.full_name && user.full_name.trim() ? user.full_name : null;
                    const username = user.permalink || user.username || 'unknown';

                    // Show display name if available, otherwise show username
                    const name = displayName || username;

                    // Only show @username if we're displaying the full_name
                    const showUsername = displayName && displayName !== username;

                    const location = user.city ?
                        (user.country_code ? `${user.city}, ${user.country_code}` : user.city) :
                        'Unknown';
                    const followers = (user.followers_count || 0).toLocaleString();
                    const tracks = (user.track_count || 0).toLocaleString();
                    const url = user.permalink_url || `https://soundcloud.com/${username}`;
                    const avatar = user.avatar_url || 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect fill="%23111" width="100" height="100"/><text x="50" y="55" font-size="40" fill="%23333" text-anchor="middle" font-family="monospace">?</text></svg>';

                    html += `
                        <div class="result-item">
                            <a href="${url}" target="_blank" class="result-avatar-link">
                                <img src="${avatar}" class="result-avatar" alt="${username}">
                            </a>
                            <div class="result-content">
                                <div class="result-header">
                                    <span class="result-index">#${index + 1}</span>
                                    <span class="result-name">${name}</span>
                                    ${showUsername ? `<span class="result-username">@${username}</span>` : ''}
                                </div>
                                <div class="result-stats">
                                    <span class="result-stat">üìç ${location}</span>
                                    <span class="result-stat">üë• <span class="result-stat-value">${followers}</span></span>
                                    <span class="result-stat">üéµ <span class="result-stat-value">${tracks}</span></span>
                                </div>
                                <a href="${url}" target="_blank" class="result-link">${url}</a>
                            </div>
                        </div>
                    `;
                });

                resultsEl.innerHTML = html;
            }

            resultsEl.style.display = 'block';
        }

        async function search() {
            const username = document.getElementById('username').value.trim();
            const location = document.getElementById('location').value.trim();

            if (!username || !location) {
                showError('username and location are required');
                return;
            }

            showLoading();

            try {
                const user = await resolveUser(username);
                const followings = await getFollowings(user.id);
                const filtered = filterByLocation(followings, location);
                displayResults(filtered, location, username);
            } catch (error) {
                showError(error.message);
            } finally {
                hideLoading();
            }
        }

        // Enter key to search
        document.getElementById('username').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });

        document.getElementById('location').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') search();
        });
    </script>
</body>
</html>
